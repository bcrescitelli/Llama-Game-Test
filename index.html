<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>LlamaLog ‚Äì Team Productivity Platform</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF (for Export Data) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Fonts -->
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");
    html, body { height: 100%; }
    body { font-family: "Poppins", sans-serif; }
    .glass { background: rgba(255,255,255,.08); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,.18) }
    .grad-bg { background: linear-gradient(135deg,#1e1b4b, #0f172a 55%, #0b1229) }
    .btn-grad { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%) }
    .btn-grad-2 { background: linear-gradient(135deg,#0ea5e9 0%,#22d3ee 100%) }
    .inventory-tab.active, .shop-tab.active { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%) }
    .achievement-glow { box-shadow: 0 0 20px rgba(102,126,234,0.5) }
    .notification-badge { animation: pulse 2s infinite }
    @keyframes pulse {0%,100%{opacity:1} 50%{opacity:.5}}
    /* Toasts */
    .toast-enter { transform: translateY(-8px); opacity: 0 }
    .toast-enter-active { transform: translateY(0); opacity: 1; transition: all .25s ease }
    .toast-leave { transform: translateY(0); opacity: 1 }
    .toast-leave-active { transform: translateY(-8px); opacity: 0; transition: all .25s ease }
    /* Mood backgrounds */
    .mood-happy { background: linear-gradient(135deg, #0ea5e9, #22c55e 60%) }
    .mood-sad { background: linear-gradient(135deg, #3b82f6, #0ea5e9 60%) }
    .mood-angry { background: linear-gradient(135deg, #ef4444, #f97316 60%) }
    .mood-energized { background: linear-gradient(135deg, #8b5cf6, #06b6d4 60%) }
    /* Square icon button fix */
    .icon-btn { width: 42px; height: 42px; display: inline-flex; align-items: center; justify-content: center; border-radius: .75rem }
  </style>
</head>

<body class="grad-bg min-h-screen text-white">
  <!-- Toast Container -->
  <div id="toastContainer" class="fixed top-4 right-4 space-y-2 z-[9999]"></div>

  <!-- Landing Page -->
  <section id="landingPage" class="min-h-screen flex items-center justify-center p-4">
    <div class="glass rounded-3xl p-8 max-w-md w-full text-center">
      <div class="text-6xl mb-4">ü¶ô</div>
      <h1 class="text-4xl font-bold mb-2">LlamaLog</h1>
      <p class="text-white/80 mb-8">Make work feel lighter with a caring llama and friendly team goals</p>

      <div class="space-y-4">
        <button onclick="UI.show('managerSignup')" class="w-full btn-grad text-white py-3 px-6 rounded-xl font-semibold hover:brightness-110 transition">
          I am a Manager ‚Äì Create Team
        </button>
        <button onclick="UI.show('managerLogin')" class="w-full bg-white/10 text-white py-3 px-6 rounded-xl font-semibold hover:bg-white/20 transition">
          Manager ‚Äì Access Homebase
        </button>
        <button onclick="UI.show('repJoin')" class="w-full btn-grad-2 text-white py-3 px-6 rounded-xl font-semibold hover:brightness-110 transition">
          I am a Rep ‚Äì Join Team
        </button>
        <button onclick="UI.show('repLogin')" class="w-full bg-white/10 text-white py-3 px-6 rounded-xl font-semibold hover:bg-white/20 transition">
          Rep ‚Äì Access Dashboard
        </button>
      </div>
    </div>
  </section>

  <!-- Manager Signup -->
  <section id="managerSignup" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="glass rounded-3xl p-8 max-w-md w-full">
      <h2 class="text-3xl font-bold mb-6 text-center">Create Your Team</h2>
      <form onsubmit="Handlers.createManagerAccount(event)" class="space-y-4">
        <input id="managerEmail" type="email" placeholder="Your email" required class="w-full p-3 rounded-xl bg-white/10 text-white placeholder-white/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400">
        <input id="teamName" type="text" placeholder="Team name" required class="w-full p-3 rounded-xl bg-white/10 text-white placeholder-white/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400">
        <button type="submit" class="w-full btn-grad text-white py-3 px-6 rounded-xl font-semibold hover:brightness-110 transition">
          Create Team and Generate Code
        </button>
      </form>
      <button onclick="UI.show('landingPage')" class="w-full mt-4 text-white/70 hover:text-white transition">‚Üê Back</button>
    </div>
  </section>

  <!-- Manager Login -->
  <section id="managerLogin" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="glass rounded-3xl p-8 max-w-md w-full">
      <h2 class="text-3xl font-bold mb-6 text-center">Access Homebase</h2>
      <form onsubmit="Handlers.managerLogin(event)" class="space-y-4">
        <input id="loginEmail" type="email" placeholder="Your email" required class="w-full p-3 rounded-xl bg-white/10 text-white placeholder-white/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400">
        <input id="loginTeamCode" type="text" placeholder="Team code" required class="w-full p-3 rounded-xl bg-white/10 text-white placeholder-white/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400">
        <button type="submit" class="w-full btn-grad text-white py-3 px-6 rounded-xl font-semibold hover:brightness-110 transition">
          Access Dashboard
        </button>
      </form>
      <button onclick="UI.show('landingPage')" class="w-full mt-4 text-white/70 hover:text-white transition">‚Üê Back</button>
    </div>
  </section>

  <!-- Rep Join (collect first name once) -->
  <section id="repJoin" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="glass rounded-3xl p-8 max-w-md w-full">
      <h2 class="text-3xl font-bold mb-6 text-center">Join Your Team</h2>
      <form onsubmit="Handlers.repJoinTeam(event)" class="space-y-4">
        <input id="repFirstName" type="text" placeholder="Your first name" required class="w-full p-3 rounded-xl bg-white/10 text-white placeholder-white/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-cyan-400">
        <input id="repEmail" type="email" placeholder="Your email" required class="w-full p-3 rounded-xl bg-white/10 text-white placeholder-white/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-cyan-400">
        <input id="repTeamCode" type="text" placeholder="Team code" required class="w-full p-3 rounded-xl bg-white/10 text-white placeholder-white/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-cyan-400">
        <button type="submit" class="w-full btn-grad-2 text-white py-3 px-6 rounded-xl font-semibold hover:brightness-110 transition">
          Request to Join
        </button>
      </form>
      <button onclick="UI.show('landingPage')" class="w-full mt-4 text-white/70 hover:text-white transition">‚Üê Back</button>
    </div>
  </section>

  <!-- Rep Login (email + team code) -->
  <section id="repLogin" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="glass rounded-3xl p-8 max-w-md w-full">
      <h2 class="text-3xl font-bold mb-6 text-center">Access Your Dashboard</h2>
      <form onsubmit="Handlers.repLogin(event)" class="space-y-4">
        <input id="repLoginEmail" type="email" placeholder="Your email" required class="w-full p-3 rounded-xl bg-white/10 text-white placeholder-white/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-cyan-400">
        <input id="repLoginTeamCode" type="text" placeholder="Team code" required class="w-full p-3 rounded-xl bg-white/10 text-white placeholder-white/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-cyan-400">
        <button type="submit" class="w-full btn-grad-2 text-white py-3 px-6 rounded-xl font-semibold hover:brightness-110 transition">
          Access Dashboard
        </button>
      </form>
      <button onclick="UI.show('landingPage')" class="w-full mt-4 text-white/70 hover:text-white transition">‚Üê Back</button>
    </div>
  </section>

  <!-- Pending Approval -->
  <section id="pendingApproval" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="glass rounded-3xl p-8 max-w-md w-full text-center">
      <div class="text-6xl mb-4">‚è≥</div>
      <h2 class="text-3xl font-bold mb-3">Approval Pending</h2>
      <p class="text-white/80 mb-6">Your manager will approve your request soon</p>
      <button onclick="Handlers.checkApprovalStatus()" class="bg-sky-500 hover:bg-sky-600 text-white py-2 px-6 rounded-xl transition">
        Check Status
      </button>
      <button onclick="UI.show('landingPage')" class="w-full mt-4 text-white/70 hover:text-white transition">‚Üê Back</button>
    </div>
  </section>

  <!-- Manager Dashboard -->
  <section id="managerDashboard" class="hidden min-h-screen p-4">
    <div class="max-w-7xl mx-auto space-y-6">
      <!-- Header -->
      <div class="glass rounded-2xl p-6">
        <div class="flex flex-wrap gap-4 items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold">Manager Homebase</h1>
            <p class="text-white/80" id="teamInfo">Team: Loading...</p>
          </div>
          <div class="flex items-center gap-3">
            <!-- Square icon buttons with consistent sizing -->
            <button id="pendingBell" onclick="UI.show('managerApprovals')" class="icon-btn bg-yellow-500 hover:bg-yellow-600 relative transition" title="Pending approvals">
              <span>üîî</span>
              <span id="pendingBadge" class="hidden absolute -top-1 -right-1 text-[10px] bg-black/80 px-1.5 py-[2px] rounded notification-badge">0</span>
            </button>
            <button onclick="Handlers.exportPDF()" class="icon-btn bg-indigo-500 hover:bg-indigo-600 transition" title="Export data as PDF">üìÑ</button>
            <button onclick="UI.show('landingPage')" class="icon-btn bg-white/10 hover:bg-white/20 transition" title="Sign out">‚éã</button>
          </div>
        </div>
      </div>

      <!-- Approvals + Activities + Checkins -->
      <div class="grid lg:grid-cols-3 gap-6">
        <!-- Pending Approvals -->
        <div class="glass rounded-2xl p-6">
          <h2 class="text-xl font-semibold mb-3">Pending approvals</h2>
          <div id="approvalsList" class="space-y-3">
            <!-- Filled dynamically -->
          </div>
          <button onclick="Handlers.refreshApprovals()" class="mt-4 text-sm bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded">
            Refresh
          </button>
        </div>

        <!-- Custom Activities (4) with smart parsing -->
        <div class="glass rounded-2xl p-6 lg:col-span-2">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold mb-2">Daily focus activities (4)</h2>
            <span class="text-white/60 text-sm">Tip: ‚ÄúLog 3 calls‚Äù will auto detect target</span>
          </div>
          <form onsubmit="Handlers.saveActivities(event)" class="grid md:grid-cols-2 gap-3">
            <input id="act1" class="bg-white/10 border border-white/20 rounded-xl p-3" placeholder="Activity 1">
            <input id="act2" class="bg-white/10 border border-white/20 rounded-xl p-3" placeholder="Activity 2">
            <input id="act3" class="bg-white/10 border border-white/20 rounded-xl p-3" placeholder="Activity 3">
            <input id="act4" class="bg-white/10 border border-white/20 rounded-xl p-3" placeholder="Activity 4">
            <button type="submit" class="md:col-span-2 btn-grad rounded-xl py-3 font-semibold hover:brightness-110 transition">Save and publish to team</button>
          </form>
        </div>

        <!-- Team Mood Chart -->
        <div class="glass rounded-2xl p-6 lg:col-span-3">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold mb-2">Team mood this week</h2>
            <span class="text-white/60 text-sm">Average of daily check ins</span>
          </div>
          <div id="moodChart" class="w-full overflow-x-auto">
            <!-- Inline SVG bars -->
          </div>
        </div>
      </div>

      <!-- Leaderboard and Gifting -->
      <div class="grid lg:grid-cols-2 gap-6">
        <div class="glass rounded-2xl p-6">
          <h2 class="text-xl font-semibold mb-3">Leaderboard</h2>
          <div id="leaderboard" class="space-y-2"></div>
        </div>
        <div class="glass rounded-2xl p-6">
          <h2 class="text-xl font-semibold mb-3">Team gifting</h2>
          <form onsubmit="Handlers.managerGift(event)" class="grid md:grid-cols-3 gap-3">
            <select id="giftRecipient" class="bg-white/10 border border-white/20 rounded-xl p-3"></select>
            <select id="giftItem" class="bg-white/10 border border-white/20 rounded-xl p-3">
              <!-- Filled with food items -->
            </select>
            <button class="btn-grad rounded-xl py-3 font-semibold hover:brightness-110 transition">Send gift</button>
          </form>
          <p class="mt-3 text-sm text-white/70">Managers can send food to any team member</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Rep Dashboard -->
  <section id="repDashboard" class="hidden min-h-screen p-4">
    <div class="max-w-6xl mx-auto space-y-6">
      <!-- Header with mood background -->
      <div id="repHeader" class="rounded-2xl p-6 glass">
        <div class="flex flex-wrap gap-4 items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="text-5xl">ü¶ô</div>
            <div>
              <h1 class="text-2xl font-bold">Welcome back, <span id="repFirstNameLabel">Rep</span></h1>
              <p class="text-white/80 text-sm">Team <span id="repTeamNameLabel"></span></p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button onclick="UI.show('landingPage')" class="icon-btn bg-white/10 hover:bg-white/20 transition" title="Sign out">‚éã</button>
          </div>
        </div>
      </div>

      <!-- Llama care and quick actions -->
      <div class="grid lg:grid-cols-3 gap-6">
        <div class="glass rounded-2xl p-6">
          <h2 class="text-xl font-semibold mb-3">Your llama</h2>
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-semibold">Name: <span id="llamaNameLabel">Unnamed</span></div>
                <div class="text-sm text-white/70">Level <span id="llamaLevel">1</span> ¬∑ XP <span id="llamaXP">0</span></div>
              </div>
              <button class="bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded text-sm" onclick="Handlers.promptRename()">Update Name</button>
            </div>

            <div>
              <div class="text-sm mb-1">Hunger</div>
              <div class="w-full bg-white/10 h-3 rounded">
                <div id="hungerBar" class="h-3 rounded bg-amber-400" style="width: 50%"></div>
              </div>
            </div>
            <div>
              <div class="text-sm mb-1">Happiness</div>
              <div class="w-full bg-white/10 h-3 rounded">
                <div id="happinessBar" class="h-3 rounded bg-emerald-400" style="width: 50%"></div>
              </div>
            </div>

            <div class="flex gap-2">
              <button onclick="Handlers.playPetting()" class="flex-1 btn-grad px-3 py-2 rounded-xl font-semibold hover:brightness-110 transition">
                Pet mini game
              </button>
              <button onclick="UI.show('foodShopModal')" class="flex-1 bg-indigo-500 hover:bg-indigo-600 px-3 py-2 rounded-xl font-semibold transition">
                Food shop
              </button>
            </div>

            <div>
              <div class="text-sm text-white/70">Inventory</div>
              <div id="inventoryList" class="mt-2 grid grid-cols-2 gap-2">
                <!-- Food items -->
              </div>
            </div>
          </div>
        </div>

        <!-- Daily Activities -->
        <div class="glass rounded-2xl p-6 lg:col-span-2">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold mb-1">Today‚Äôs focus</h2>
            <span class="text-sm text-white/60">Complete tasks to earn coins and happiness</span>
          </div>
          <div id="activitiesList" class="mt-3 space-y-3"></div>
        </div>

        <!-- Daily Check In -->
        <div class="glass rounded-2xl p-6">
          <h2 class="text-xl font-semibold mb-3">Daily check in</h2>
          <form onsubmit="Handlers.submitCheckin(event)" class="space-y-3">
            <label class="block text-sm">Mood (1 to 5)
              <input id="checkMood" type="number" min="1" max="5" value="3" class="mt-1 w-full p-2 rounded bg-white/10 border border-white/20">
            </label>
            <label class="block text-sm">Energy (1 to 5)
              <input id="checkEnergy" type="number" min="1" max="5" value="3" class="mt-1 w-full p-2 rounded bg-white/10 border border-white/20">
            </label>
            <label class="block text-sm">Break time today (minutes)
              <input id="checkBreak" type="number" min="0" max="120" value="10" class="mt-1 w-full p-2 rounded bg-white/10 border border-white/20">
            </label>
            <button class="btn-grad rounded-xl py-2 w-full font-semibold hover:brightness-110 transition">Submit</button>
          </form>
          <p class="text-xs text-white/70 mt-2">Your llama will rest during your break and remind you to rest too</p>
        </div>

        <!-- Team Social -->
        <div class="glass rounded-2xl p-6 lg:col-span-2">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold mb-3">Team social</h2>
            <span id="coinsLabel" class="text-sm text-white/70">Coins: 0</span>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <h3 class="font-semibold mb-2">Send a gift</h3>
              <form onsubmit="Handlers.repGift(event)" class="grid grid-cols-3 gap-2">
                <select id="repGiftRecipient" class="bg-white/10 border border-white/20 rounded-xl p-2 col-span-2"></select>
                <select id="repGiftItem" class="bg-white/10 border border-white/20 rounded-xl p-2"></select>
                <button class="btn-grad rounded-xl py-2 col-span-3 font-semibold hover:brightness-110 transition">Send</button>
              </form>
            </div>
            <div>
              <h3 class="font-semibold mb-2">Inbox</h3>
              <div id="giftInbox" class="space-y-2">
                <!-- Gifts appear here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Achievements -->
        <div class="glass rounded-2xl p-6">
          <h2 class="text-xl font-semibold mb-3">Achievements</h2>
          <ul id="achievementsList" class="space-y-1 text-sm"></ul>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal: Food Shop -->
  <div id="foodShopModal" class="hidden fixed inset-0 z-[999] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60" onclick="UI.hide('foodShopModal')"></div>
    <div class="relative glass rounded-2xl p-6 max-w-md w-full">
      <h2 class="text-xl font-semibold mb-3">Food shop</h2>
      <div id="shopItems" class="space-y-2"></div>
      <button onclick="UI.hide('foodShopModal')" class="mt-4 w-full bg-white/10 hover:bg-white/20 py-2 rounded">Close</button>
    </div>
  </div>

  <!-- Simple screens router -->
  <script>
    /***************
     * State model *
     ***************/
    const STORAGE_KEY = "llamalog_state_v2";
    const defaultFoods = {
      hay: { label: "Hay", hunger: 20, happiness: 2, cost: 5 },
      carrot: { label: "Carrot", hunger: 15, happiness: 5, cost: 8 },
      espresso: { label: "Espresso", hunger: 0, happiness: 8, cost: 10 },
      treat: { label: "Treat", hunger: 5, happiness: 10, cost: 12 }
    };
    const profanityList = [
      "fuck","shit","bitch","asshole","dick","cunt","bastard","slut",
      "whore","fag","nigger","retard","twat","prick","wank","bollock"
    ];

    function loadState() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { teams: {} };
      } catch {
        return { teams: {} };
      }
    }
    function saveState(state) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    function uid(len = 12) {
      // Stronger team codes ‚Äì base32-ish uppercase + digits with crypto
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      const arr = new Uint8Array(len);
      crypto.getRandomValues(arr);
      return Array.from(arr, b => chars[b % chars.length]).join("");
    }
    function todayKey() {
      const d = new Date(); return d.toISOString().slice(0,10);
    }

    /****************
     * UI utilities *
     ****************/
    const UI = {
      show(id) {
        document.querySelectorAll("section, #foodShopModal").forEach(s => s.classList.add("hidden"));
        document.getElementById(id)?.classList.remove("hidden");
        // route-specific refresh
        if (id === "managerDashboard") Screens.renderManager();
        if (id === "repDashboard") Screens.renderRep();
        if (id === "managerApprovals") Screens.renderManager();
        if (id === "foodShopModal") Screens.renderShop();
      },
      hide(id) {
        document.getElementById(id)?.classList.add("hidden");
      },
      toast(msg, type = "info") {
        const container = document.getElementById("toastContainer");
        const card = document.createElement("div");
        const base = "toast-enter glass rounded-xl px-4 py-3 text-sm";
        const color = type === "success" ? "border-emerald-400"
                    : type === "error" ? "border-rose-400"
                    : type === "warn" ? "border-amber-400"
                    : "border-white/20";
        card.className = `${base} ${color}`;
        card.textContent = msg;
        container.appendChild(card);
        requestAnimationFrame(() => card.classList.replace("toast-enter","toast-enter-active"));
        setTimeout(() => {
          card.classList.add("toast-leave");
          card.classList.replace("toast-enter-active","toast-leave-active");
          setTimeout(() => card.remove(), 250);
        }, 2500);
      },
      format(name, max=24){
        if(!name) return "";
        return name.length>max ? name.slice(0,max-1)+"‚Ä¶" : name;
      }
    };

    /*****************
     * Auth session  *
     *****************/
    let session = { role: null, teamCode: null, email: null };

    /**********************
     * Domain operations  *
     **********************/
    const Domain = {
      ensureTeam(state, code) {
        if (!state.teams[code]) state.teams[code] = {
          teamName: "",
          managerEmail: "",
          createdAt: Date.now(),
          activities: [],   // [{ label, target (optional) }]
          pending: [],      // [{ email, firstName, requestedAt }]
          members: {}       // email -> member
        };
        return state.teams[code];
      },
      parseActivity(raw) {
        if (!raw) return null;
        // Extract first integer + clean label without numbers
        const match = raw.match(/(\d+)/);
        const target = match ? parseInt(match[1],10) : null;
        let label = raw.replace(/\d+/g,"").trim();
        if (!label) label = raw.trim();
        return { label, target: isNaN(target) ? null : target };
      },
      ensureMember(team, email) {
        if (!team.members[email]) {
          team.members[email] = {
            firstName: "",
            email,
            coins: 0,
            llama: {
              name: "",
              hunger: 60,       // 0 to 100 (higher is fuller)
              happiness: 60,    // 0 to 100
              xp: 0,
              level: 1,
              lastTick: Date.now(),
              fedStreak: 0
            },
            inventory: { hay: 1, carrot: 1, espresso: 0, treat: 0 },
            giftsInbox: [],    // [{from, itemKey, at}]
            achievements: {
              wellFedStreak: 0,
              giftGiver: 0,
              productStreak: 0
            },
            progress: {},      // date -> { [actIndex]: { count or done } }
            checkins: {}       // date -> { mood, energy, breakMin }
          };
        }
        return team.members[email];
      },
      tickLlama(member) {
        const now = Date.now();
        const elapsedMin = Math.max(0, Math.round((now - (member.llama.lastTick || now)) / 60000));
        if (elapsedMin <= 0) return;
        member.llama.lastTick = now;

        // Hunger decays slowly
        member.llama.hunger = Math.max(0, member.llama.hunger - 0.5 * (elapsedMin/5));
        // Happiness influenced by hunger
        const hungerPenalty = member.llama.hunger < 30 ? 0.6 : member.llama.hunger < 50 ? 0.3 : 0;
        member.llama.happiness = Math.max(0, Math.min(100, member.llama.happiness - hungerPenalty * (elapsedMin/5)));
      },
      addXP(member, amount=2){
        member.llama.xp += amount;
        // Level up every 50 XP
        while (member.llama.xp >= member.llama.level * 50) {
          member.llama.xp -= member.llama.level * 50;
          member.llama.level += 1;
          UI.toast("Your llama leveled up", "success");
        }
      },
      feed(member, itemKey) {
        const f = defaultFoods[itemKey];
        if (!f) return false;
        if ((member.inventory[itemKey] || 0) <= 0) return false;
        member.inventory[itemKey] -= 1;
        member.llama.hunger = Math.min(100, member.llama.hunger + f.hunger);
        member.llama.happiness = Math.min(100, member.llama.happiness + f.happiness);
        member.llama.fedStreak = Math.min(365, (member.llama.fedStreak || 0) + 1);
        member.achievements.wellFedStreak = Math.max(member.achievements.wellFedStreak || 0, member.llama.fedStreak);
        Domain.addXP(member, 3);
        return true;
      },
      pet(member){
        member.llama.happiness = Math.min(100, member.llama.happiness + 2);
        Domain.addXP(member, 1);
      }
    };

    /*****************
     * Screen binds  *
     *****************/
    const Screens = {
      ///////////////////////
      // MANAGER DASHBOARD //
      ///////////////////////
      renderManager(){
        const state = loadState();
        const team = state.teams[session.teamCode];
        if (!team) return UI.show("landingPage");
        document.getElementById("teamInfo").textContent =
          `Team ${team.teamName} ‚Ä¢ Code ${session.teamCode} ‚Ä¢ Manager ${team.managerEmail}`;

        // Pending approvals
        const approvalsEl = document.getElementById("approvalsList");
        approvalsEl.innerHTML = "";
        (team.pending || []).forEach((p, idx) => {
          const row = document.createElement("div");
          row.className = "flex items-center justify-between bg-white/5 border border-white/10 rounded-xl p-3";
          row.innerHTML = `
            <div>
              <div class="font-medium">${UI.format(p.firstName)} <span class="text-white/60">(${UI.format(p.email)})</span></div>
              <div class="text-xs text-white/60">Requested ${new Date(p.requestedAt).toLocaleString()}</div>
            </div>
            <div class="flex gap-2">
              <button class="bg-emerald-500 hover:bg-emerald-600 px-3 py-1.5 rounded" onclick="Handlers.approve(${idx})">Approve</button>
              <button class="bg-rose-500 hover:bg-rose-600 px-3 py-1.5 rounded" onclick="Handlers.reject(${idx})">Reject</button>
            </div>
          `;
          approvalsEl.appendChild(row);
        });

        // Bell badge
        const badge = document.getElementById("pendingBadge");
        const count = (team.pending || []).length;
        badge.textContent = count;
        badge.classList.toggle("hidden", count === 0);

        // Fill activities inputs
        ["act1","act2","act3","act4"].forEach((id, i) => {
          document.getElementById(id).value = team.activities[i]?.target
            ? `${team.activities[i].label} ${team.activities[i].target}`
            : (team.activities[i]?.label || "");
        });

        // Team mood chart (last 7 days)
        const moodChart = document.getElementById("moodChart");
        const days = Array.from({length:7}).map((_,i)=> {
          const d = new Date(); d.setDate(d.getDate() - (6-i));
          return d.toISOString().slice(0,10);
        });
        const points = days.map(day => {
          const vals = Object.values(team.members).map(m => m.checkins?.[day]?.mood).filter(v => typeof v === "number");
          if (!vals.length) return null;
          const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
          return Math.round(avg*10)/10;
        });

        // Render simple SVG bars
        const width = 520, height = 160, barW = 60, gap = 16;
        const maxVal = 5;
        const svg = [
          `<svg width="${Math.max(width, (barW+gap)*7+gap)}" height="${height}" viewBox="0 0 ${Math.max(width, (barW+gap)*7+gap)} ${height}" xmlns="http://www.w3.org/2000/svg">`,
          `<rect x="0" y="0" width="100%" height="100%" fill="rgba(255,255,255,0.03)" rx="12"/>`
        ];
        days.forEach((day, i) => {
          const val = points[i] || 0;
          const h = (val / maxVal) * (height-40);
          const x = gap + i*(barW+gap);
          const y = height-20 - h;
          svg.push(`<rect x="${x}" y="${y}" width="${barW}" height="${h}" rx="8" fill="#60a5fa"/>`);
          svg.push(`<text x="${x+barW/2}" y="${height-6}" text-anchor="middle" font-size="10" fill="#cbd5e1">${day.slice(5)}</text>`);
          if (val) svg.push(`<text x="${x+barW/2}" y="${y-6}" text-anchor="middle" font-size="11" fill="#e2e8f0">${val}</text>`);
        });
        svg.push(`</svg>`);
        moodChart.innerHTML = svg.join("");

        // Leaderboard
        const lb = Object.values(team.members)
          .map(m => ({ name: m.firstName || m.email, coins: m.coins, lvl: m.llama.level }))
          .sort((a,b)=> (b.coins - a.coins) || (b.lvl - a.lvl))
          .slice(0,10);
        const lbEl = document.getElementById("leaderboard");
        lbEl.innerHTML = "";
        lb.forEach((m, i) => {
          const row = document.createElement("div");
          row.className = "flex items-center justify-between bg-white/5 border border-white/10 rounded-xl p-3";
          row.innerHTML = `<div class="text-white/80">#${i+1}</div>
            <div class="font-semibold">${UI.format(m.name)}</div>
            <div class="text-sm text-white/70">Coins ${m.coins} ‚Ä¢ Lv ${m.lvl}</div>`;
          lbEl.appendChild(row);
        });

        // Gifting selectors
        const recSel = document.getElementById("giftRecipient");
        recSel.innerHTML = "";
        Object.values(team.members).forEach(m=>{
          const opt = document.createElement("option");
          opt.value = m.email; opt.textContent = m.firstName || m.email;
          recSel.appendChild(opt);
        });
        const giftSel = document.getElementById("giftItem");
        giftSel.innerHTML = "";
        Object.entries(defaultFoods).forEach(([k,v])=>{
          const opt = document.createElement("option");
          opt.value = k; opt.textContent = `${v.label} (Cost ${v.cost})`;
          giftSel.appendChild(opt);
        });
      },

      //////////////////
      // REP DASHBOARD //
      //////////////////
      renderRep(){
        const state = loadState();
        const team = state.teams[session.teamCode];
        if (!team) return UI.show("landingPage");
        const member = Domain.ensureMember(team, session.email);
        Domain.tickLlama(member);
        saveState(state);

        // Header
        document.getElementById("repFirstNameLabel").textContent = member.firstName || session.email;
        document.getElementById("repTeamNameLabel").textContent = team.teamName;

        // Mood background swap based on happiness/hunger
        const header = document.getElementById("repHeader");
        header.classList.remove("mood-happy","mood-sad","mood-angry","mood-energized");
        const h = member.llama.happiness, g = member.llama.hunger;
        if (h > 70 && g > 50) header.classList.add("mood-happy");
        else if (h < 35 && g < 30) header.classList.add("mood-angry");
        else if (h < 45) header.classList.add("mood-sad");
        else header.classList.add("mood-energized");

        // Llama panel
        document.getElementById("llamaNameLabel").textContent = member.llama.name || "Unnamed";
        document.getElementById("llamaLevel").textContent = member.llama.level;
        document.getElementById("llamaXP").textContent = member.llama.xp;
        document.getElementById("hungerBar").style.width = `${Math.round(member.llama.hunger)}%`;
        document.getElementById("happinessBar").style.width = `${Math.round(member.llama.happiness)}%`;

        // Inventory list
        const inv = document.getElementById("inventoryList");
        inv.innerHTML = "";
        Object.entries(member.inventory).forEach(([k,qty])=>{
          const f = defaultFoods[k];
          const item = document.createElement("div");
          item.className = "bg-white/5 border border-white/10 rounded-xl p-3 flex items-center justify-between";
          item.innerHTML = `
            <div>
              <div class="font-medium">${f.label}</div>
              <div class="text-xs text-white/60">Qty ${qty}</div>
            </div>
            <button class="bg-emerald-500 hover:bg-emerald-600 px-3 py-1.5 rounded text-sm" ${qty<=0?"disabled class='opacity-50 cursor-not-allowed'":""}
              onclick="Handlers.feed('${k}')">Feed</button>`;
          inv.appendChild(item);
        });

        // Activities
        const list = document.getElementById("activitiesList");
        list.innerHTML = "";
        const dayKey = todayKey();
        if (!member.progress[dayKey]) member.progress[dayKey] = {};
        (team.activities || []).slice(0,4).forEach((act, idx)=>{
          const slot = member.progress[dayKey][idx] || (act.target ? { count: 0 } : { done: false });
          member.progress[dayKey][idx] = slot;

          const row = document.createElement("div");
          row.className = "bg-white/5 border border-white/10 rounded-xl p-3 flex items-center justify-between";
          if (act.target) {
            row.innerHTML = `
              <div>
                <div class="font-semibold">${UI.format(act.label)}</div>
                <div class="text-xs text-white/60">Target ${act.target} ‚Ä¢ Progress ${slot.count}</div>
              </div>
              <div class="flex items-center gap-2">
                <button class="bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded" onclick="Handlers.adjustProgress(${idx},-1)">‚Äì</button>
                <button class="bg-emerald-500 hover:bg-emerald-600 px-3 py-1.5 rounded" onclick="Handlers.adjustProgress(${idx},1)">+1</button>
              </div>
            `;
          } else {
            row.innerHTML = `
              <div>
                <div class="font-semibold">${UI.format(act.label)}</div>
                <div class="text-xs text-white/60">Checkbox</div>
              </div>
              <div>
                <label class="inline-flex items-center gap-2">
                  <input type="checkbox" ${slot.done ? "checked":""} onchange="Handlers.toggleDone(${idx}, this.checked)" />
                  <span>Done</span>
                </label>
              </div>
            `;
          }
          list.appendChild(row);
        });
        saveState(state);

        // Coins label
        document.getElementById("coinsLabel").textContent = `Coins: ${member.coins}`;

        // Gifting dropdowns
        const recSel = document.getElementById("repGiftRecipient");
        recSel.innerHTML = "";
        Object.values(team.members).forEach(m=>{
          if (m.email === member.email) return;
          const opt = document.createElement("option");
          opt.value = m.email; opt.textContent = m.firstName || m.email;
          recSel.appendChild(opt);
        });
        const itemSel = document.getElementById("repGiftItem");
        itemSel.innerHTML = "";
        Object.entries(member.inventory).forEach(([k,qty])=>{
          if (qty>0){
            const opt = document.createElement("option");
            opt.value = k; opt.textContent = `${defaultFoods[k].label} (You have ${qty})`;
            itemSel.appendChild(opt);
          }
        });

        // Inbox
        const inbox = document.getElementById("giftInbox");
        inbox.innerHTML = "";
        (member.giftsInbox || []).slice(-10).reverse().forEach(g=>{
          const row = document.createElement("div");
          row.className = "bg-white/5 border border-white/10 rounded-xl p-3 flex items-center justify-between";
          row.innerHTML = `<div class="text-sm"><span class="text-white/80">Gift from ${UI.format(g.fromName || g.from)}</span> ¬∑ ${defaultFoods[g.itemKey]?.label}</div>
            <button class="bg-emerald-500 hover:bg-emerald-600 px-3 py-1.5 rounded text-sm" onclick="Handlers.claimGift('${g.id}')">Claim</button>`;
          inbox.appendChild(row);
        });

        // Achievements
        const ach = document.getElementById("achievementsList");
        ach.innerHTML = "";
        const A = member.achievements;
        [
          ["Well fed streak", A.wellFedStreak || 0],
          ["Gift giver", A.giftGiver || 0],
          ["Productivity streak", A.productStreak || 0]
        ].forEach(([name,val])=>{
          const li = document.createElement("li");
          li.textContent = `${name}: ${val}`;
          ach.appendChild(li);
        });
      },

      renderShop(){
        // Rep shop content
        const state = loadState();
        const team = state.teams[session.teamCode];
        if (!team) return;
        const member = team.members[session.email];
        const wrap = document.getElementById("shopItems");
        wrap.innerHTML = "";
        Object.entries(defaultFoods).forEach(([k,v])=>{
          const row = document.createElement("div");
          row.className = "flex items-center justify-between bg-white/5 border border-white/10 rounded-xl p-3";
          row.innerHTML = `
            <div>
              <div class="font-semibold">${v.label}</div>
              <div class="text-xs text-white/60">Hunger +${v.hunger}, Happiness +${v.happiness}</div>
            </div>
            <button class="bg-indigo-500 hover:bg-indigo-600 px-3 py-1.5 rounded"
              onclick="Handlers.buyItem('${k}', ${v.cost})">Buy ${v.cost} coins</button>`;
          wrap.appendChild(row);
        });
        // Manager gifting shop uses separate selectors elsewhere
      }
    };

    /****************
     * Event logic  *
     ****************/
    const Handlers = {
      // Manager
      createManagerAccount(e){
        e.preventDefault();
        const email = document.getElementById("managerEmail").value.trim().toLowerCase();
        const teamName = document.getElementById("teamName").value.trim();
        if (!email || !teamName) return;

        const state = loadState();
        const code = uid(10);
        const team = Domain.ensureTeam(state, code);
        team.teamName = teamName;
        team.managerEmail = email;
        team.activities = []; team.pending = []; team.members = team.members || {};

        saveState(state);
        session = { role: "manager", teamCode: code, email };
        UI.toast(`Team created. Code ${code}`, "success");
        UI.show("managerDashboard");
      },
      managerLogin(e){
        e.preventDefault();
        const email = document.getElementById("loginEmail").value.trim().toLowerCase();
        const code = document.getElementById("loginTeamCode").value.trim().toUpperCase();
        const state = loadState();
        const team = state.teams[code];
        if (!team || team.managerEmail !== email) {
          return UI.toast("Invalid email or team code", "error");
        }
        session = { role: "manager", teamCode: code, email };
        UI.show("managerDashboard");
      },
      approve(idx){
        const state = loadState();
        const team = state.teams[session.teamCode];
        const p = team.pending[idx];
        if (!p) return;
        const m = Domain.ensureMember(team, p.email);
        m.firstName = p.firstName;
        // grant starter coins
        m.coins = Math.max(m.coins, 10);
        team.pending.splice(idx,1);
        saveState(state);
        UI.toast("Rep approved", "success");
        Screens.renderManager();
      },
      reject(idx){
        const state = loadState();
        const team = state.teams[session.teamCode];
        team.pending.splice(idx,1);
        saveState(state);
        UI.toast("Request removed", "warn");
        Screens.renderManager();
      },
      refreshApprovals(){ Screens.renderManager(); },
      saveActivities(e){
        e.preventDefault();
        const a = ["act1","act2","act3","act4"].map(id => Domain.parseActivity(document.getElementById(id).value.trim())).filter(Boolean);
        const state = loadState();
        const team = state.teams[session.teamCode];
        team.activities = a.slice(0,4);
        // Publish to team: reset today progress scaffolding so everyone sees new slots
        const dayKey = todayKey();
        Object.values(team.members).forEach(m=>{
          m.progress[dayKey] = {};
          team.activities.forEach((act,i)=>{
            m.progress[dayKey][i] = act.target ? { count: 0 } : { done: false };
          });
        });
        saveState(state);
        UI.toast("Activities saved and published to team", "success");
        Screens.renderManager();
      },
      managerGift(e){
        e.preventDefault();
        const state = loadState();
        const team = state.teams[session.teamCode];
        const recipientEmail = document.getElementById("giftRecipient").value;
        const itemKey = document.getElementById("giftItem").value;
        const rec = team.members[recipientEmail];
        if (!rec) return UI.toast("No such team member", "error");
        rec.giftsInbox.push({ id: uid(8), from: session.email, fromName: team.managerEmail, itemKey, at: Date.now() });
        saveState(state);
        UI.toast("Gift sent", "success");
        Screens.renderManager();
      },

      exportPDF(){
        const state = loadState();
        const team = state.teams[session.teamCode];
        if (!team) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "pt", format: "a4" });

        const margin = 48;
        let y = margin;

        doc.setFont("helvetica","bold");
        doc.setFontSize(18);
        doc.text(`LlamaLog ‚Äì Team Report`, margin, y);
        doc.setFontSize(12);
        doc.setFont("helvetica","normal");
        y += 18;
        doc.text(`Team: ${team.teamName}`, margin, y); y+=14;
        doc.text(`Code: ${session.teamCode}`, margin, y); y+=14;
        doc.text(`Manager: ${team.managerEmail}`, margin, y); y+=22;

        doc.setFont("helvetica","bold");
        doc.text("Members", margin, y); y+=14;
        doc.setFont("helvetica","normal");

        Object.values(team.members).forEach(m=>{
          const line = `${m.firstName || m.email}  ‚Ä¢  Lv ${m.llama.level}  ‚Ä¢  Coins ${m.coins}`;
          doc.text(line, margin, y); y+=14;
        });

        y+=10; doc.setFont("helvetica","bold"); doc.text("Daily Focus", margin, y); y+=14; doc.setFont("helvetica","normal");
        team.activities.forEach((a,i)=>{
          doc.text(`${i+1}. ${a.label}${a.target? " ‚Äì Target "+a.target:""}`, margin, y); y+=14;
        });

        // Average mood last 7 days
        y+=12; doc.setFont("helvetica","bold"); doc.text("Mood (last 7 days avg)", margin, y); y+=14;
        doc.setFont("helvetica","normal");
        const days = Array.from({length:7}).map((_,i)=> {
          const d = new Date(); d.setDate(d.getDate() - (6-i));
          return d.toISOString().slice(0,10);
        });
        days.forEach(day=>{
          const vals = Object.values(team.members).map(m => m.checkins?.[day]?.mood).filter(v => typeof v === "number");
          const avg = vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1) : "‚Äì";
          doc.text(`${day}: ${avg}`, margin, y); y+=14;
        });

        doc.save(`LlamaLog_${team.teamName}_report.pdf`);
        UI.toast("PDF exported", "success");
      },

      // Rep
      repJoinTeam(e){
        e.preventDefault();
        const firstName = document.getElementById("repFirstName").value.trim();
        const email = document.getElementById("repEmail").value.trim().toLowerCase();
        const code = document.getElementById("repTeamCode").value.trim().toUpperCase();
        const state = loadState();
        const team = state.teams[code];
        if (!team) return UI.toast("Team code not found", "error");
        // prevent duplicate pending
        if (team.members[email]) {
          session = { role: "rep", teamCode: code, email };
          return UI.show("repDashboard");
        }
        if (team.pending.find(p=>p.email===email)) {
          session = { role: "rep", teamCode: code, email };
          return UI.show("pendingApproval");
        }
        team.pending.push({ email, firstName, requestedAt: Date.now() });
        saveState(state);
        session = { role: "rep", teamCode: code, email };
        UI.toast("Request sent to manager", "success");
        UI.show("pendingApproval");
      },
      checkApprovalStatus(){
        const state = loadState();
        const team = state.teams[session.teamCode];
        if (!team) return UI.show("landingPage");
        if (team.members[session.email]) {
          UI.show("repDashboard");
        } else {
          UI.toast("Still pending", "warn");
        }
      },
      repLogin(e){
        e.preventDefault();
        const email = document.getElementById("repLoginEmail").value.trim().toLowerCase();
        const code = document.getElementById("repLoginTeamCode").value.trim().toUpperCase();
        const state = loadState();
        const team = state.teams[code];
        if (!team || !team.members[email]) {
          // If pending, go to pending screen
          if (team && team.pending.find(p=>p.email===email)) {
            session = { role: "rep", teamCode: code, email };
            return UI.show("pendingApproval");
          }
          return UI.toast("Not approved yet or invalid", "error");
        }
        session = { role: "rep", teamCode: code, email };
        UI.show("repDashboard");
      },

      promptRename(){
        const newName = prompt("Enter llama name");
        if (!newName) return;
        const lower = newName.toLowerCase();
        if (profanityList.some(bad => lower.includes(bad))) {
          return UI.toast("Please use a different name", "error");
        }
        const state = loadState();
        const team = state.teams[session.teamCode];
        const member = team.members[session.email];
        member.llama.name = newName.trim();
        saveState(state);
        UI.toast("Name updated", "success");
        Screens.renderRep();
      },
      playPetting(){
        // simple clicker ‚Äì each click gives a tiny happiness bump
        const state = loadState();
        const team = state.teams[session.teamCode];
        const member = team.members[session.email];
        Domain.pet(member);
        saveState(state);
        UI.toast("Your llama feels cared for", "success");
        Screens.renderRep();
      },
      feed(itemKey){
        const state = loadState();
        const team = state.teams[session.teamCode];
        const member = team.members[session.email];
        if (Domain.feed(member, itemKey)) {
          member.coins += 1; // tiny reward
          saveState(state);
          UI.toast(`Fed ${defaultFoods[itemKey].label}`, "success");
          Screens.renderRep();
        } else {
          UI.toast("No item available", "warn");
        }
      },
      buyItem(itemKey, cost){
        const state = loadState();
        const team = state.teams[session.teamCode];
        const member = team.members[session.email];
        if (member.coins < cost) return UI.toast("Not enough coins", "error");
        member.coins -= cost;
        member.inventory[itemKey] = (member.inventory[itemKey] || 0) + 1;
        saveState(state);
        UI.toast("Purchased", "success");
        Screens.renderRep(); Screens.renderShop();
      },
      adjustProgress(idx, delta){
        const state = loadState();
        const team = state.teams[session.teamCode];
        const member = team.members[session.email];
        const day = todayKey();
        const act = team.activities[idx];
        const slot = member.progress[day][idx];
        if (!act?.target) return;
        slot.count = Math.max(0, Math.min(act.target, (slot.count||0) + delta));
        // rewards when completing target
        if (slot.count === act.target) {
          member.coins += 5;
          member.llama.happiness = Math.min(100, member.llama.happiness + 5);
          Domain.addXP(member, 4);
          UI.toast(`Completed: ${act.label}`, "success");
        }
        saveState(state);
        Screens.renderRep();
      },
      toggleDone(idx, checked){
        const state = loadState();
        const team = state.teams[session.teamCode];
        const member = team.members[session.email];
        const day = todayKey();
        const slot = member.progress[day][idx];
        slot.done = !!checked;
        if (slot.done) {
          member.coins += 3;
          member.llama.happiness = Math.min(100, member.llama.happiness + 4);
          Domain.addXP(member, 3);
        }
        saveState(state);
        Screens.renderRep();
      },
      submitCheckin(e){
        e.preventDefault();
        const mood = parseInt(document.getElementById("checkMood").value,10);
        const energy = parseInt(document.getElementById("checkEnergy").value,10);
        const breakMin = parseInt(document.getElementById("checkBreak").value,10);
        const state = loadState();
        const team = state.teams[session.teamCode];
        const member = team.members[session.email];
        member.checkins[todayKey()] = { mood, energy, breakMin, at: Date.now() };
        // Simple effect: better mood gives instant happiness nudge
        member.llama.happiness = Math.min(100, member.llama.happiness + Math.max(0, mood-2));
        // Reminder toast
        if (breakMin > 0) {
          setTimeout(()=> UI.toast("Llama says: time to rest for a moment"), breakMin * 60000);
        }
        saveState(state);
        UI.toast("Check in saved", "success");
        Screens.renderRep();
        Screens.renderManager(); // update chart if manager is open
      },
      repGift(e){
        e.preventDefault();
        const state = loadState();
        const team = state.teams[session.teamCode];
        const member = team.members[session.email];

        const recipientEmail = document.getElementById("repGiftRecipient").value;
        const itemKey = document.getElementById("repGiftItem").value;
        if ((member.inventory[itemKey] || 0) <= 0) return UI.toast("You do not have this item", "error");

        member.inventory[itemKey] -= 1;
        const rec = team.members[recipientEmail];
        rec.giftsInbox.push({ id: uid(8), from: session.email, fromName: member.firstName, itemKey, at: Date.now() });
        member.achievements.giftGiver = (member.achievements.giftGiver || 0) + 1;
        saveState(state);
        UI.toast("Gift sent", "success");
        Screens.renderRep();
      },
      claimGift(id){
        const state = loadState();
        const team = state.teams[session.teamCode];
        const member = team.members[session.email];
        const idx = member.giftsInbox.findIndex(g=>g.id===id);
        if (idx<0) return;
        const g = member.giftsInbox[idx];
        member.inventory[g.itemKey] = (member.inventory[g.itemKey]||0) + 1;
        member.giftsInbox.splice(idx,1);
        saveState(state);
        UI.toast("Gift claimed", "success");
        Screens.renderRep();
      }
    };

    /********************
     * Random messages  *
     ********************/
    const tips = [
      "One more call can turn the day around",
      "Small consistent steps create momentum",
      "Try a five minute desk reset then dive in",
      "Focus on one conversation that matters",
      "Log progress as you go. Your llama loves it"
    ];
    function randomTip(){
      UI.toast("Llama says: " + tips[Math.floor(Math.random()*tips.length)], "info");
    }
    // periodic nudge (every 4 minutes demo cycle)
    setInterval(randomTip, 240000);

    /********************
     * Seed and router  *
     ********************/
    // Start in landing
    UI.show("landingPage");

    // Demo seed if empty (optional)
    (function seed(){
      const s = loadState();
      if (Object.keys(s.teams).length === 0) {
        const code = uid(10);
        s.teams[code] = {
          teamName: "Demo Team",
          managerEmail: "manager@example.com",
          createdAt: Date.now(),
          activities: [
            { label: "Log calls", target: 3 },
            { label: "Send follow ups", target: 5 },
            { label: "Update pipeline", target: null },
            { label: "Prep opportunities", target: null }
          ],
          pending: [],
          members: {}
        };
        const m1 = Domain.ensureMember(s.teams[code], "alex@example.com");
        m1.firstName = "Alex";
        m1.coins = 20;
        const m2 = Domain.ensureMember(s.teams[code], "casey@example.com");
        m2.firstName = "Casey";
        m2.coins = 12;
        saveState(s);
      }
    })();

    // Lightweight heartbeat to keep llama state evolving while on page
    setInterval(()=>{
      if (!session.teamCode || !session.email) return;
      const state = loadState();
      const team = state.teams[session.teamCode];
      if (!team) return;
      const member = team.members[session.email];
      if (!member) return;
      Domain.tickLlama(member);
      saveState(state);
      // Live bars refresh on rep screen
      if (!document.getElementById("repDashboard").classList.contains("hidden")) {
        document.getElementById("hungerBar").style.width = `${Math.round(member.llama.hunger)}%`;
        document.getElementById("happinessBar").style.width = `${Math.round(member.llama.happiness)}%`;
      }
    }, 30000); // every 30s

  </script>
</body>
</html>
